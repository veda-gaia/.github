name: Project - Status from Events

on:
  workflow_call:
    inputs:
      project_url:
        type: string
        required: false
        default: "https://github.com/orgs/veda-gaia/projects/1"
    secrets:
      GH_PROJECT_TOKEN:
        required: true
  push:
  pull_request:
    types: [opened, closed]
  issues:
    types: [labeled]

jobs:
  detect-issue-number:
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      issue: ${{ steps.extract.outputs.issue }}
    steps:
      - name: Detect issue number
        id: extract
        env:
          EVENT_NAME: ${{ github.event_name }}
          BRANCH_REF: ${{ github.ref_name }}
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref || '' }}
          PR_TITLE: ${{ github.event.pull_request.title || '' }}
        run: |
          set -euo pipefail
          ISSUE=""
          extract_issue() {
            local source="$1"
            if [[ "$source" =~ ([0-9]+)[-_] ]]; then
              ISSUE="${BASH_REMATCH[1]}"
            fi
          }
          if [[ "${EVENT_NAME}" == "push" ]] && [[ "${BRANCH_REF}" != "" ]]; then
            extract_issue "${BRANCH_REF}"
          elif [[ "${EVENT_NAME}" == "pull_request" ]]; then
            extract_issue "${PR_HEAD_REF}"
            if [[ -z "$ISSUE" && "${PR_TITLE}" =~ \#([0-9]+) ]]; then
              ISSUE="${BASH_REMATCH[1]}"
            fi
          fi
          echo "issue=$ISSUE" >> "$GITHUB_OUTPUT"

  set-in-progress:
    needs: detect-issue-number
    if: github.event_name == 'push' && needs.detect-issue-number.outputs.issue != ''
    uses: veda-gaia/.github/.github/workflows/project-set-status.yml@main
    with:
      organization: veda-gaia
      project_number: 1
      repo: ${{ github.event.repository.name }}
      issue_number: "${{ needs.detect-issue-number.outputs.issue }}"
      status_name: In Progress
    secrets:
      GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}

  set-code-review:
    needs: detect-issue-number
    if: github.event_name == 'pull_request' && github.event.action == 'opened' && needs.detect-issue-number.outputs.issue != ''
    uses: veda-gaia/.github/.github/workflows/project-set-status.yml@main
    with:
      organization: veda-gaia
      project_number: 1
      repo: ${{ github.event.repository.name }}
      issue_number: "${{ needs.detect-issue-number.outputs.issue }}"
      status_name: Code Review
    secrets:
      GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}

  link-pr-to-issue:
    needs:
      - detect-issue-number
      - set-code-review
    if: github.event_name == 'pull_request' && github.event.action == 'opened' && needs.detect-issue-number.outputs.issue != ''
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Link pull request to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          ISSUE_NUMBER: ${{ needs.detect-issue-number.outputs.issue }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          if [[ -z "$ISSUE_NUMBER" ]]; then
            echo "No issue number detected, skipping link."
            exit 0
          fi
          CURRENT_BODY=$(gh api "repos/$OWNER/$REPO/pulls/$PR_NUMBER" --jq '.body // ""')
          LINK_LINE="Closes #$ISSUE_NUMBER"

          if [[ "$CURRENT_BODY" == *"Closes #$ISSUE_NUMBER"* ]]; then
            echo "Pull request body already closes issue #$ISSUE_NUMBER."
            exit 0
          fi

          if [[ -z "$CURRENT_BODY" ]]; then
            UPDATED_BODY="$LINK_LINE"
          else
            UPDATED_BODY="$CURRENT_BODY"$'\n\n'"$LINK_LINE"
          fi

          gh api "repos/$OWNER/$REPO/pulls/$PR_NUMBER" \
            --method PATCH \
            -f body="$UPDATED_BODY"

          echo "Added 'Closes #$ISSUE_NUMBER' to pull request #$PR_NUMBER."

  # ---- Label issues when PR merges into develop ----
  label-merged-to-develop:
    permissions:
      issues: write
    needs: detect-issue-number
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'develop' && needs.detect-issue-number.outputs.issue != ''
    runs-on: ubuntu-latest
    steps:
      - name: Add merged-to-develop label to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          ISSUE_NUMBER: ${{ needs.detect-issue-number.outputs.issue }}
        run: |
          set -euo pipefail
          if [[ -z "$ISSUE_NUMBER" ]]; then
            echo "No issue number detected, skipping label."
            exit 0
          fi
          gh api repos/$OWNER/$REPO/issues/$ISSUE_NUMBER/labels \
            -X POST \
            -f labels='["merged-to-develop"]'

  collect-ready-for-staging:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'homolog'
    runs-on: ubuntu-latest
    outputs:
      issues: ${{ steps.collect.outputs.issues }}
    steps:
      - name: Collect issues labeled merged-to-develop
        id: collect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          gh api --paginate "/repos/$OWNER/$REPO/issues?labels=merged-to-develop&state=open" > issues.json
          ISSUES=$(jq -s -c '
            [.[]
             | .[]
             | select(.pull_request | not)
             | .number]
          ' issues.json)
          if [[ -z "$ISSUES" || "$ISSUES" == "" ]]; then
            ISSUES="[]"
          fi
          echo "issues=$ISSUES" >> "$GITHUB_OUTPUT"

  set-qa-staging:
    needs: collect-ready-for-staging
    if: needs.collect-ready-for-staging.outputs.issues != '' && needs.collect-ready-for-staging.outputs.issues != '[]'
    strategy:
      matrix:
        issue: ${{ fromJSON(needs.collect-ready-for-staging.outputs.issues) }}
    uses: veda-gaia/.github/.github/workflows/project-set-status.yml@main
    with:
      organization: veda-gaia
      project_number: 1
      repo: ${{ github.event.repository.name }}
      issue_number: "${{ matrix.issue }}"
      status_name: QA/Staging
    secrets:
      GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}

  ready-for-prod-on-issue-label:
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'uat-approved'
    uses: veda-gaia/.github/.github/workflows/project-set-status.yml@main
    with:
      organization: veda-gaia
      project_number: 1
      repo: ${{ github.event.repository.name }}
      issue_number: "${{ github.event.issue.number }}"
      status_name: Ready for Prod
    secrets:
      GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}

  collect-ready-for-prod:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    outputs:
      issues: ${{ steps.collect.outputs.issues }}
    steps:
      - name: Collect Ready for Prod issues
        id: collect
        env:
          GH_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          gh api graphql --paginate -f query='
            query($owner:String!, $project:Int!, $endCursor:String) {
              organization(login: $owner) {
                projectV2(number: $project) {
                  items(first: 100, after: $endCursor) {
                    nodes {
                      content {
                        __typename
                        ... on Issue {
                          number
                          repository { name }
                        }
                      }
                      fieldValueByName(name: "Status") {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                        }
                      }
                    }
                    pageInfo {
                      hasNextPage
                      endCursor
                    }
                  }
                }
              }
            }
          ' -f owner="$OWNER" -F project=1 -F endCursor=null > items.json
          ISSUES=$(jq -s -c --arg repo "$REPO" '
            [.[].data.organization.projectV2.items.nodes[]?
             | select(.content.__typename == "Issue" and .content.repository.name == $repo)
             | {number: .content.number, status: (.fieldValueByName.name // "")}
             | select(.status == "Ready for Prod")
             | .number]
          ' items.json)
          echo "issues=$ISSUES" >> "$GITHUB_OUTPUT"

  set-done:
    needs: collect-ready-for-prod
    if: needs.collect-ready-for-prod.outputs.issues != '' && needs.collect-ready-for-prod.outputs.issues != '[]'
    strategy:
      matrix:
        issue: ${{ fromJSON(needs.collect-ready-for-prod.outputs.issues) }}
    uses: veda-gaia/.github/.github/workflows/project-set-status.yml@main
    with:
      organization: veda-gaia
      project_number: 1
      repo: ${{ github.event.repository.name }}
      issue_number: "${{ matrix.issue }}"
      status_name: Done
    secrets:
      GH_PROJECT_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}

      ### THIS WORKS
